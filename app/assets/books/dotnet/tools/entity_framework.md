# ENTITY FRAMEWORK

## DbContext object 
- Manage database connection (represents a session with the database)
- Use c# classes called 'data' or 'entity models' to access data
- Configure model & relationship
- Querying/Saving data to the database
- Configure change tracking
- Caching
- Transaction management

## DbSet<T>
Represents a table in the database

## ENTITY CREATION
***Code First***
We can hand code a model as a C# class and then use EF Migrations to create and update a database from the model. EF Migrations help us to create, update our database and keep the database synced with our model classes. 
To create a database from scratch using 

***Database First***
We can generate a model from an existing database

## EF DATABASE PROVIDERS
Database providers are available as NuGet packages and they are easy to install using the NuGet package manager.
 
SQL Server 2012 onward	Microsoft.EntityFrameworkCore.SqlServer
https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.SqlServer
Microsoft SQL Server database provider for Entity Framework Core.

SQLite	Microsoft.EntityFrameworkCore.Sqlite
https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.Sqlite

MySQL	MySql.Data.EntityFrameworkCore
https://www.nuget.org/packages/MySql.Data.EntityFrameworkCore

Oracle 	Oracle.EntityFrameworkCore
https://www.nuget.org/packages/Oracle.EntityFrameworkCore/

Db2	IBM.EntityFrameworkCore
https://www-112.ibm.com/software/howtobuy/passportadvantage/paocustomer/sdma/SDMA?P0=DOWNLOAD_SEARCH_BY_PART_NO&FIELD_SEARCH_TYPE=3&searchVal=CC6XFML


Microsoft.EntityFrameworkCore.Design	
Shared design-time components for Entity Framework Core Tools
https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.Design

Microsoft.EntityFrameworkCore.Tools	
help us in running Migrations related
https://www.nuget.org/packages/Microsoft.EntityFrameworkCore.Tools/

 
## EF Core Migrations

Migrations allow us to easily create a new database and then incrementally update the database schema to keep it in sync with the application models. 
Run migrations using
- .NET Core CLI (all platforms)
- Package Manager Console (From Visual Studio)

Migrations commands sync your model with the database
- Add-Migration
- Remove-Migration
- Update-Database
By creating classes derived from
Class Migration
- Up()      // CreateTable and CreateIndex 
- Down()    // Drop ...
We are free to add/update code in the files generated by migration commands such as Add-Migration.
in the EF Core ***/Migrations*** directory  
Every time you will add a new migration using the Add-Migration command, a new file will be created in the Migrations folder.

On the database server, EF creates a ***__EFMigrationsHistory table*** to keep track of all the migrations already ran against the database.

download.page(dotnet/tools/entity_framework_in_memory.md)

## SAMPLES

- https://itnext.io/how-to-build-an-event-driven-asp-net-core-microservice-architecture-e0ef2976f33f
- [Onion Architecture In .Net 5](https://github.com/JayKrishnareddy/OnionArchitecture)
PM>Update-Database


## CODE FIRST SAMPLE

Entities: Product, Customer, Order, ProductOrders, Entities relationships 

![](assets/books/dotnet/tools/assets/ef-model01.png)

***[project_root]/Models/***

```cs
public class Customer
{
    [Key]
    public int Id { get; set; } 
    [Required]
    public string FirstName { get; set; } 
    [Required]
    public string LastName { get; set; } 
    public string Phone { get; set; } 
    public ICollection<Order> Orders { get; set; }
}

public class Order
{
    [Key]
    public int Id { get; set; } 
    public DateTime? OrderDate { get; set; } 
    public int CustomerId { get; set; } 
    public Customer Customer { get; set; } 
    public ICollection<ProductOrder> ProductOrders { get; set; }
}

public class Product
{
    [Key]        // = primary key column of the table
    public int Id { get; set; }         
    [Required]   // = Non-Nullable column
    public string Name { get; set; } 
    [Column(TypeName = "decimal(18, 2)")]
    public decimal Price { get; set; }
}

public class ProductOrder
{
    [Key]
    public int Id { get; set; } 
    public int Quantity { get; set; } 
    public int ProductId { get; set; } 
    public int OrderId { get; set; } 
    public Product Product { get; set; } 
    public Order Order { get; set; }
}

```

***[project_root]/Data/***
```cs
public class OnlineShopDbContext : DbContext
{
    public OnlineShopDbContext(DbContextOptions<OnlineShopDbContext> options):base(options)
    {         
    }
 
    public DbSet<Product> Products { get; set; }
    public DbSet<Customer> Customers { get; set; }
    public DbSet<Order> Orders { get; set; }
    public DbSet<ProductOrder> ProductOrders { get; set; }
}
```

Startup.cs
```cs
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllersWithViews();
 
    services.AddDbContext<OnlineShopDbContext>(options =>
        options.UseSqlServer(Configuration.GetConnectionString("DefaultConnection")));
 
}
```

appsettings.json
```xml
{
   "ConnectionStrings":{
      "DefaultConnection":"Server=DESKTOP-6SDKTRC; Database=OnlineShopDb; Trusted_Connection=True; MultipleActiveResultSets=true"
   },
   "Logging":{
      "LogLevel":{
         "Default":"Information",
         "Microsoft":"Warning",
         "Microsoft.Hosting.Lifetime":"Information"
      }
   },
   "AllowedHosts":"*"
}
```

### Generate the database
We have created 
* Entity models
* DbContext object 
* Configuration files
* AddDbContext() call

Migrations will  generate the database
Package Manager Console 
PM>Add-Migration InitialDatabaseCreate       add our first migration 
This creates /Migrations/20210501121314_InitialDatabaseCreate.cs
```cs
public partial class InitialDatabaseCreate : Migration
{
   protected override void Up(MigrationBuilder migrationBuilder)
   {
        migrationBuilder.CreateTable(
            name: "Customers",
            columns: table => new
            {
                Id = table.Column<int>(type: "int", nullable: false)
                    .Annotation("SqlServer:Identity", "1, 1"),
                FirstName = table.Column<string>(type: "nvarchar(max)", nullable: false),
                LastName = table.Column<string>(type: "nvarchar(max)", nullable: false),
                Phone = table.Column<string>(type: "nvarchar(max)", nullable: true)
            },
            constraints: table =>
            {
                table.PrimaryKey("PK_Customers", x => x.Id);
            });
         
       ...
       ...
   }
     
   protected override void Down(MigrationBuilder migrationBuilder)
   {
        ...
        ...
        migrationBuilder.DropTable(name: "Customers");
   }
}
```

>PM>Update-Database          Generate the database (1st run)

### Let's add a field to a class = a column to a table
```cs
public class Customer
{
   ... 
    public string Email { get; set; }   â† Add this
 }
```
>PM>Add-Migration AddEmailInCustomers    This add a new migration to sync your model with the database
>PM>Update-Database

### Seeding Data
Add initial data in the Products table by overriding DbContext.OnModelCreating() 

```cs
public class OnlineShopDbContext : DbContext
{
    public OnlineShopDbContext(DbContextOptions<OnlineShopDbContext> options) 
        : base(options)
    {
    }
 
    public DbSet<Product> Products { get; set; }
    public DbSet<Customer> Customers { get; set; }
    public DbSet<Order> Orders { get; set; }
    public DbSet<ProductOrder> ProductOrders { get; set; }
 
    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity<Product>().HasData(
            new Product() { Id = 1, Name = "Apple iPad", Price = 1000 },
            new Product() { Id = 2, Name = "Samsung Smart TV", Price = 1500 },
            new Product() { Id = 3, Name = "Nokia 130", Price = 1200 });
    }
}
```
>PM>Add-Migration SeedProductsData
This Create a Migrations/SeedProductsData class
Code is calling the MigrationBuilder.InsertData()
  
```cs
public partial class SeedProductsData : Migration
{
    protected override void Up(MigrationBuilder migrationBuilder)
    {
        migrationBuilder.InsertData(
            table: "Products",
            columns: new[] { "Id", "Name", "Price" },
            values: new object[] { 1, "Apple iPad", 1000m });
 
        migrationBuilder.InsertData(
            table: "Products",
            columns: new[] { "Id", "Name", "Price" },
            values: new object[] { 2, "Samsung Smart TV", 1500m });
 
        migrationBuilder.InsertData(
            table: "Products",
            columns: new[] { "Id", "Name", "Price" },
            values: new object[] { 3, "Nokia 130", 1200m });
    }
}
```
>PM>Update-Database 
 
## ASP.NET Core + EF Core 

1. Inject OnlineShopDbContext class in our HomeController constructor
2. Call DbSet<Products>.ToListAsync(): This automatically fetch data from the database

```cs
public class HomeController : Controller
{
    private readonly OnlineShopDbContext _context;
 
    public HomeController(OnlineShopDbContext context)
    {
        _context = context;
    }
 
    public async Task<IActionResult> Index()
    {
        return View(await _context.Products.ToListAsync());
    }
}

@model IEnumerable<Product>
 
@{
    ViewData["Title"] = "Home Page";
}
<h2>Products</h2>
<table class="table">
    <thead>
        <tr>
            <th>
                @Html.DisplayNameFor(model => model.Id)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Name)
            </th>
            <th>
                @Html.DisplayNameFor(model => model.Price)
            </th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.Id)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Name)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Price)
                </td>
            </tr>
        }
    </tbody>
</table>
```

## More 
-https://visualstudiomagazine.com/articles/2020/02/12/ef-migrations.aspx
- https://www.ezzylearning.net/tutorial/data-access-in-asp-net-core-using-ef-core-code-first
- https://medium.com/@andrevitorlopes/entities-relationship-with-entity-framework-core-ffdd8643ea4